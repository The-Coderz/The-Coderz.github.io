<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>The Coders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="The Coders">
<meta property="og:url" content="https://The-Coderz.github.io/index.html">
<meta property="og:site_name" content="The Coders">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The Coders">
  
    <link rel="alternate" href="/atom.xml" title="The Coders" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">The Coders</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://The-Coderz.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-基于TCL语法的expect交互式脚本使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/16/基于TCL语法的expect交互式脚本使用/" class="article-date">
  <time datetime="2017-04-16T08:00:13.000Z" itemprop="datePublished">2017-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="基于TCL语法的expect交互式脚本使用"><a href="#基于TCL语法的expect交互式脚本使用" class="headerlink" title="基于TCL语法的expect交互式脚本使用"></a>基于TCL语法的expect交互式脚本使用</h2><p>​    有些事情是是头疼且重复的，譬如登陆线上服务器存在相同密码验证的跳板机、没有持续交付自动化流程的线上代码编译、构建、部署操作等。今天来说说TCL语法的expect脚本（极其简单），用可用的脚本来注释说明即可：</p>
<h3 id="免密码登陆服务器"><a href="#免密码登陆服务器" class="headerlink" title="免密码登陆服务器"></a>免密码登陆服务器</h3><p>​    <strong><em>密码的当然是要写在脚本里的，或者只输入一次，这不是一个hack脚本…</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/expect -f</div><div class="line"></div><div class="line">proc terminal:password:get &#123;promptString&#125; &#123;		# TCL的子程序定义方式</div><div class="line"></div><div class="line">     # Turn off echoing, but leave newlines on.  That looks better.</div><div class="line">     # Note that the terminal is left in cooked mode, so people can still use backspace</div><div class="line">     exec stty -echo echonl &lt;@stdin</div><div class="line"></div><div class="line">     # Print the prompt</div><div class="line">     puts -nonewline stdout $promptString</div><div class="line">     flush stdout</div><div class="line"></div><div class="line">     # Read that password!  :^)</div><div class="line">     gets stdin password</div><div class="line"></div><div class="line">     # Reset the terminal</div><div class="line">     exec stty echo -echonl &lt;@stdin</div><div class="line"></div><div class="line">     return $password</div><div class="line">&#125;</div><div class="line"></div><div class="line">proc chooseMachine &#123; &#125; &#123;</div><div class="line">    puts &quot;请选择机器\n1) 10.0.0.73 (codecenter-pre default);\n2) 10.0.2.153 (codecenter-prod);\n3) 10.0.2.154 (codecenter-prod);\na) 10.0.0.72 (codecenter-node-pre);\nb) 10.0.2.151 (codecenter-node-prod);\nc) 10.0.2.152 (codecenter-node-prod);&quot;;</div><div class="line">    gets stdin choice;</div><div class="line">    switch $choice &#123;</div><div class="line">        1 &#123;</div><div class="line">            return &quot;10.0.0.73&quot;;</div><div class="line">        &#125;</div><div class="line">        1 &#123;</div><div class="line">            return &quot;10.0.2.153&quot;;</div><div class="line">        &#125;</div><div class="line">        2 &#123;</div><div class="line">            return &quot;10.0.2.154&quot;;</div><div class="line">        &#125;</div><div class="line">        a &#123;</div><div class="line">            return &quot;10.0.0.72&quot;;</div><div class="line">        &#125;</div><div class="line">        b &#123;</div><div class="line">            return &quot;10.0.2.151&quot;;</div><div class="line">        &#125;</div><div class="line">        c &#123;</div><div class="line">            return &quot;10.0.2.152&quot;;</div><div class="line">        &#125;</div><div class="line">        default &#123;</div><div class="line">            return &quot;10.0.0.73&quot;;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">proc chooseJumper &#123; IP &#125; &#123;</div><div class="line">    switch $IP &#123;</div><div class="line">        &quot;10.0.0.73&quot; &#123; </div><div class="line">            return &quot;120.27.220.50&quot;;</div><div class="line">        &#125;</div><div class="line">        &quot;10.0.0.72&quot; &#123;</div><div class="line">            return &quot;120.27.220.50&quot;;</div><div class="line">        &#125;</div><div class="line">        default &#123;</div><div class="line">            return &quot;121.43.182.162&quot;;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">proc chooseJumperAccount &#123; JUMPER &#125; &#123;</div><div class="line">    switch $JUMPER &#123;</div><div class="line">        &quot;120.27.220.50&quot; &#123;</div><div class="line">            return &quot;root&quot;;</div><div class="line">        &#125;</div><div class="line">        default &#123;</div><div class="line">            return &quot;admin&quot;;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">set IP [ chooseMachine ];		# TCL 语法的创建变量 + 子程序调用方式</div><div class="line">set JUMPER [ chooseJumper $IP ];</div><div class="line">set JUMPER_ACCOUNT [ chooseJumperAccount $JUMPER ];</div><div class="line">set PASSWORD [ terminal:password:get &quot;输入密码&quot; ];</div><div class="line">spawn ssh van.yzt@100.69.206.131;			# expect 语法，生成一个子程序用于接着后续的“expect”语句交互</div><div class="line">expect &quot;*password:&quot;;</div><div class="line">send &quot;$PASSWORD\r&quot;;</div><div class="line">expect &quot;*$*&quot;;</div><div class="line">send &quot;sudo su admin\r&quot;;</div><div class="line">expect &quot;*password*&quot;;</div><div class="line">send &quot;$PASSWORD\r&quot;;</div><div class="line">expect &quot;*$*&quot;;</div><div class="line">send &quot;ssh $JUMPER_ACCOUNT@$JUMPER\r&quot;;</div><div class="line">expect &quot;*]*&quot;;</div><div class="line">send &quot;ssh root@$IP\r&quot;;</div><div class="line">set timeout 1;</div><div class="line">expect &#123;</div><div class="line">    &quot;*yes/no&quot; &#123; send &quot;yes\r&quot;;exp_continue; &#125;</div><div class="line">    &quot;*password:&quot; &#123; send &quot;Codecenter123\r&quot;; &#125;</div><div class="line">&#125;</div><div class="line">interact;			# 告知子程序，停留在机器上不结束自己，提供给用户后续的操作</div></pre></td></tr></table></figure>
<p>​    同样的，利用expect，还可以做其他的操作，例如打包源码-&gt;上传代码到服务器-&gt;在服务器上编译、构建、部署等。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://The-Coderz.github.io/2017/04/16/基于TCL语法的expect交互式脚本使用/" data-id="cj1kekdp4000vb7ahxjsaelcp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Docker简单使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/16/Docker简单使用/" class="article-date">
  <time datetime="2017-04-16T07:54:55.000Z" itemprop="datePublished">2017-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/16/Docker简单使用/">Docker简单使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://zhuanlan.zhihu.com/p/24633328" target="_blank" rel="external">史上最简单Android源码编译环境搭建方法</a>这篇分享介绍了借助Docker来编译Android源码，Docker可以直接把编译工具链和Ubuntu系统整体打包，保证了编译环境和官方的一致。<br>我用的macOS，之前尝试过编译AOSP，出现各种问题，采用虚拟机的方式也常常编译不过，看到可以用docker的新方式，打算尝试用一下。但是从我实际操作来看，docker在mac上是很慢的，并不比虚拟机快多少，在编译AOSP时也会造成卡死，因为在mac平台上docker是要运行在一个虚拟机上的。在尝试docker编译AOSP失败后，我最终还是用macOS编译了，最终成功烧录到nexus手机上。<br>虽然docker不适合我编译AOSP，但是作为一个操作系统级虚拟化实现方案，还是非常优秀滴。写一个编译器做成一个镜像，放在docker容器里运行还是绰绰有余的，比如《自制编译器》里的<code>cbc编译器</code>, 有人就做了一个镜像上传到<a href="https://hub.docker.com/r/leungwensen/cbc-ubuntu-64bit/" target="_blank" rel="external">DockerHub</a>上了，这样就避免了需要配置一堆环境依赖的麻烦了。<br>也算是对Docker研究了半天，简单记录下docker的用法吧。</p>
<hr>
<h2 id="Docker简介"><a href="#Docker简介" class="headerlink" title="Docker简介"></a>Docker简介</h2><h3 id="为什么说Docker比虚拟机快呢？"><a href="#为什么说Docker比虚拟机快呢？" class="headerlink" title="为什么说Docker比虚拟机快呢？"></a>为什么说Docker比虚拟机快呢？</h3><p>因为Docker容器需要的开销有限。和传统的虚拟化相比，容器运行不需要模拟层和管理层，而是使用操作系统的系统调用接口。这降低了运行单个容器所需的开销，也使得宿主机中可以运行更多容器。<br>但这个是对Host机为Linux而言的，macOS上运行docker容器本质上还是跑在linux虚拟机上的。</p>
<h3 id="什么是docker"><a href="#什么是docker" class="headerlink" title="什么是docker"></a>什么是docker</h3><p>镜像是Docker生命周期中的构建或打包阶段，而容器则是启动或执行阶段。<br>简单来说，Docker就是：</p>
<ul>
<li>一个镜像格式</li>
<li>一系列标准的操作</li>
<li>一个执行环境</li>
</ul>
<p>镜像是基于联合文件系统的一种层式的结构，由一系列指令一步一步构建出来，例如：添加一个文件；执行一个名人；打开一个端口。<br>当从一个镜像启动容器时，Docker会在该镜像的最底层加载一个读写文件系统，我们想在Docker中运行的程序就是在这个读写层中执行的。<br>下图是Docker的文件系统层。<br><img src="http://p1.bqimg.com/567571/d31fea71fb692f4d.png" alt="Docker文件系统层"></p>
<p>构建镜像最方便的做法是写一个Dockerfile文件，让docker自带的工具读它，然后生出一个镜像文件来。<br>Dockerfile使用基本的基于DSL语法的指令来构建一个Docker镜像，之后使用docker build命令基于该Dockerfile中的指令构建一个新的镜像。<br>每条指令都会创建一个新的镜像层并对镜像进行提交。Docker大体上按照如下的流程执行Dockerfile中的指令。</p>
<ul>
<li>Docker从基础镜像运行一个容器。</li>
<li>执行一条指令，对容器做出修改。</li>
<li>执行类似docker commit的操作，提交一个新的镜像层。</li>
<li>Docker再基于刚提交的镜像运行一个新容器。</li>
<li>执行Dockerfile中的下一条指令，直到所有指令都执行完毕。</li>
</ul>
<p>这里给两个简单的例子，可以自己研究下：</p>
<ul>
<li><a href="https://hub.docker.com/r/leungwensen/cbc-ubuntu-64bit/" target="_blank" rel="external">cbc-ubuntu-64bit</a></li>
<li><a href="https://hub.docker.com/r/kylemanna/aosp/" target="_blank" rel="external">aosp</a></li>
</ul>
<hr>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>去<a href="https://www.docker.com/" target="_blank" rel="external">Docker官网</a>下载对应操作系统的安装包后，就可以使用了。<br>打开 Kitematic, 可以在这里下载镜像，dockerhub的形式跟github很像，可以commit、pull等。<br><img src="http://p1.bqimg.com/567571/9d49704a11c5ecad.jpg" alt=""></p>
<p>Docker是基于C/S架构的，它有一个docker程序，既能作为客户端，也可以作为服务端。作为客户端时，docker程序向Docker守护进程发送请求（如请求返回守护进程自身的信息），然后再对返回的请求结果进行处理。</p>
<h3 id="通过docker-info-可以得到的一些信息"><a href="#通过docker-info-可以得到的一些信息" class="headerlink" title="通过docker info 可以得到的一些信息"></a>通过docker info 可以得到的一些信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ docker info      </div><div class="line">Containers: 10</div><div class="line"> Running: 1</div><div class="line"> Paused: 0</div><div class="line"> Stopped: 9</div><div class="line">Images: 7</div><div class="line">Server Version: 1.12.6</div><div class="line">//...</div><div class="line">Registry: https://index.docker.io/v1/</div><div class="line">WARNING: No kernel memory <span class="built_in">limit</span> support</div><div class="line">Insecure Registries:</div><div class="line"> 127.0.0.0/8</div></pre></td></tr></table></figure>
<h3 id="创建交互式容器"><a href="#创建交互式容器" class="headerlink" title="创建交互式容器"></a>创建交互式容器</h3><p>我们告诉Docker执行<code>docker run</code>命令，我们告诉Docker基于<code>ubuntu</code>镜像来创建容器，如果本地没有该镜像的话，Docker会连接官方维护的Docker Hub Registry查找该镜像，下载并保存到本地宿主机中。 <code>-i</code>保证容器中STDIN是开启的，<code>-t</code>告诉Docker为要创建的容器分配一个伪tty终端。这样，新创建的容器才能提供一个交互式shell。最后的<code>/bin/bash</code>告诉Docker在新容器中要运行什么命令。其中<code>--name</code>参数告诉Docker创建一个名为<code>test_container</code>的容器。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo docker --name test_container run -i -t ubuntu /bin/bash</div><div class="line">//...</div><div class="line">root@12345:/<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>这样，我们就能看到容器内的shell了。容器的id是12345。容器的主机名就是该容器的ID。具体可以通过<code>cat /etc/hosts</code>查看。<br>输入<code>exit</code>,就可以返回宿主机的命令行了。一旦退出容器，<code>/bin/bash</code>命令也就结束了，容器也随之停止运行。但容器是仍然存在的。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root@12345:/<span class="comment"># exit</span></div></pre></td></tr></table></figure></p>
<p>用<code>docker ps -a</code>命令查看当前系统中容器的列表</p>
<p>Docker容器重新启动的时候，会沿用docker run命令时指定的参数来运行。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker restart (container name or id)</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="创建守护式容器"><a href="#创建守护式容器" class="headerlink" title="创建守护式容器"></a>创建守护式容器</h3><p><code>-d</code>参数告诉Docker把容器放到后台运行。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker run --name daemon_dave <span class="_">-d</span> ubuntu /bin/sh -c <span class="string">"while true; do echo hello world; sleep 1; done"</span></div></pre></td></tr></table></figure></p>
<h3 id="容器内部都在干些什么"><a href="#容器内部都在干些什么" class="headerlink" title="容器内部都在干些什么"></a>容器内部都在干些什么</h3><p>用<code>docker logs</code>命令来获取容器的日志。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker logs (container name or id)</div></pre></td></tr></table></figure></p>
<h3 id="查看容器内的进程"><a href="#查看容器内的进程" class="headerlink" title="查看容器内的进程"></a>查看容器内的进程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker top (container name or id)</div></pre></td></tr></table></figure>
<h3 id="在容器内部运行进程"><a href="#在容器内部运行进程" class="headerlink" title="在容器内部运行进程"></a>在容器内部运行进程</h3><p>通过<code>docker exec</code>命令在容器内部额外启动新进程，<br>如下启动了新的后台任务和交互式任务。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker <span class="built_in">exec</span> <span class="_">-d</span> (container name or id) touch /etc/new_config_file</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker <span class="built_in">exec</span> -t -i (container name or id) /bin/bash</div></pre></td></tr></table></figure>
<h3 id="停止守护式容器"><a href="#停止守护式容器" class="headerlink" title="停止守护式容器"></a>停止守护式容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker stop (container name or id)</div></pre></td></tr></table></figure>
<h3 id="自动重启容器"><a href="#自动重启容器" class="headerlink" title="自动重启容器"></a>自动重启容器</h3><p><code>--restart</code>标志会检查容器的退出代码，并据此来决定是否重启容器。<br>比如<code>--restart=onfailure:5</code>表示Docker会尝试自动重启该容器，最多重启5次。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker run --restart=always --name daemon_dave <span class="_">-d</span> ubuntu /bin/sh -c <span class="string">"while true; do echo hello world; sleep 1; done"</span></div></pre></td></tr></table></figure></p>
<h3 id="深入容器"><a href="#深入容器" class="headerlink" title="深入容器"></a>深入容器</h3><p><code>docker inspect</code>命令会对容器进行详细的检查，然后返回其配置信息，包括名称、命令、网络配置等。这是一大串json数据，可以用<code>--format</code>标志来选定查看结果。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo docker inspect --format=<span class="string">'&#123;&#123;.Args&#125;&#125;'</span> (container name or id)</div><div class="line">[run.sh docker]</div></pre></td></tr></table></figure></p>
<h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker rm (container name or id)</div></pre></td></tr></table></figure>
<p>一次删除所有容器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker rm `docker ps <span class="_">-a</span> -q`</div></pre></td></tr></table></figure></p>
<h3 id="列出镜像"><a href="#列出镜像" class="headerlink" title="列出镜像"></a>列出镜像</h3><p>用<code>docker images</code>得到本地的镜像列表。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sudo docker images</div><div class="line">REPOSITORY  TAG     IMAGE ID       CREATED    	SIZE</div><div class="line">ubuntu      latest  104bec311bcd   4 weeks ago  129 MB</div><div class="line">ubuntu      14.04   xxx   		   x weeks ago  xxx MB</div></pre></td></tr></table></figure></p>
<p>镜像保存在仓库中，而仓库在于Registry中，默认的Registry是Docker Hub。<br>每个镜像仓库都可以存放很多镜像（比如ubuntu仓库包含了ubuntu各个版本的镜像）。<br>执行<code>sudo docker pull ubuntu</code>命令来拉取ubuntu仓库中所有内容。<br>每个镜像在列出来时都带有一个标签，用于对组成特定镜像的一些镜像层镜像标记。<br>用如下的方式来指定该仓库的某一镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker run -ti ubuntu:12.04 /bin/bash</div></pre></td></tr></table></figure></p>
<p>Docker Hub中有两种类型的仓库：用户仓库和顶层仓库。<br><code>用户名/仓库名</code>这种形式表示用户仓库，是由Docker用户创建的；<br>顶层仓库只包含仓库名部分，由Docker内部人来管理的。</p>
<hr>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>因为我只是想用docker来配一个编译aosp的环境，对于Docker的很多高级功能还没有接触，比如利用连接和卷之类的Docker特性来组合并管理运行与Docker中的应用、创建多容器的应用栈等。</p>
<hr>
<p> 相关链接<br><a href="https://zhuanlan.zhihu.com/p/24633328" target="_blank" rel="external">史上最简单Android源码编译环境搭建方法</a><br><a href="https://hub.docker.com/r/leungwensen/cbc-ubuntu-64bit/" target="_blank" rel="external">cbc-ubuntu-64bit</a><br><a href="http://numbbbbb.com/2016/09/26/20160926_%E7%94%A8%20Docker%20%E5%BF%AB%E9%80%9F%E9%85%8D%E7%BD%AE%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" target="_blank" rel="external">用 Docker 快速配置前端开发环境</a><br><a href="https://book.douban.com/subject/26285268/" target="_blank" rel="external">《第一本Docker书》</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://The-Coderz.github.io/2017/04/16/Docker简单使用/" data-id="cj1kekdok000fb7ahu69g436e" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/工具-docker/">工具 docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-在macOS 10.12 上编译 Android 5.1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/16/在macOS 10.12 上编译 Android 5.1/" class="article-date">
  <time datetime="2017-04-16T07:54:55.000Z" itemprop="datePublished">2017-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/16/在macOS 10.12 上编译 Android 5.1/">在macOS 10.12 上编译 Android 5.1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<p>官方文档虽然也有介绍，但是macOS平台上的编译环境问题还存在很多坑。本文介绍下如何在在macOS 10.12 上编译 Android 5.1源码，导入源码到Android Studio中，把系统烧录到Nexus6手机中。</p>
<hr>
<h2 id="搭建编译环境"><a href="#搭建编译环境" class="headerlink" title="搭建编译环境"></a>搭建编译环境</h2><h3 id="创建分区"><a href="#创建分区" class="headerlink" title="创建分区"></a>创建分区</h3><p>AOSP源码需要一个支持大小写敏感的文件系统，100G是至少要的。<a href="https://source.android.com/source/initializing.html#setting-up-a-mac-os-x-build-environment" target="_blank" rel="external">官网</a>有详细的介绍，这里简单列一下。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hdiutil create -type SPARSE -fs <span class="string">'Case-sensitive Journaled HFS+'</span> -size 40g ~/android.dmg</div></pre></td></tr></table></figure></p>
<p>然后挂载这个分区：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hdiutil attach ~/android.dmg -mountpoint /Volumes/android;</div></pre></td></tr></table></figure></p>
<h3 id="切换shell"><a href="#切换shell" class="headerlink" title="切换shell"></a>切换shell</h3><p>Android的相关编译只能是使用bash.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ chsh -s /bin/bash</div></pre></td></tr></table></figure></p>
<p>重启终端。</p>
<h3 id="安装Xcode"><a href="#安装Xcode" class="headerlink" title="安装Xcode"></a>安装Xcode</h3><p>1、这里需要两个Xcode，可以用命令切换需要使用的Xcode，会有不同的用处。</p>
<ul>
<li>去AppStore下载最新的Xcode</li>
<li>到<a href="https://developer.apple.com/download/more/" target="_blank" rel="external">这里</a>下载5.1.1的Xcode</li>
</ul>
<p>2、创建一个<code>/Developer/SDK</code>文件夹，从Xcode5.1.1中把<code>MacOSX10.8.sdk</code>从<code>Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/</code>复制到 <code>/Developer/SDK</code>中。<br>3、从<code>Xcode5.1.1.dmg</code>复制Xcode.app 到  <code>/Developer</code>目录中。<br>4、从AppStore下载的最新版Xcode会默认放在<code>/Applications</code>目录中<br>5、给两个版本的Xcode都安装command line tools<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sudo xcode-select -switch /Developer/Xcode.app</div><div class="line">$ xcode-select --install</div><div class="line">$ sudo xcode-select -switch /Applications/Xcode.app</div><div class="line">$ xcode-select --install</div></pre></td></tr></table></figure></p>
<h3 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h3><p>编译Android5.1需要jdk1.7，去<a href="http://www.oracle.com/technetwork/java/javase/downloads/jre7-downloads-1880261.html" target="_blank" rel="external">官网</a>下载.<br>如果有切换多个版本的jdk需求的话，可以使用<code>jenv</code>这个工具，参考<a href="http://boxingp.github.io/blog/2015/01/25/manage-multiple-versions-of-java-on-os-x/" target="_blank" rel="external">在OS X中使用jEnv管理多个Java版本</a></p>
<h3 id="安装其他软件"><a href="#安装其他软件" class="headerlink" title="安装其他软件"></a>安装其他软件</h3><p>1、安装MacPorts，需要去<a href="https://www.macports.org/install.php" target="_blank" rel="external">官网</a>下载对应版本的MacPorts<br>2、配置port命令环境变量<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">export</span> PATH=/opt/<span class="built_in">local</span>/bin:<span class="variable">$PATH</span></div></pre></td></tr></table></figure></p>
<p>3、下载依赖包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ POSIXLY_CORRECT=1 sudo port install gmake libsdl git gnupg</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><p>直接去google官方下载会很慢，这里推荐用<a href="https://lug.ustc.edu.cn/wiki/mirrors/help/aosp" target="_blank" rel="external">中科大镜像</a><br>1、首先下载 repo 工具。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ mkdir ~/bin</div><div class="line">$ PATH=~/bin:<span class="variable">$PATH</span></div><div class="line">$ curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo</div><div class="line"><span class="comment">## 如果上述 URL 不可访问，可以用下面的：</span></div><div class="line"><span class="comment">## curl https://storage-googleapis.proxy.ustclug.org/git-repo-downloads/repo &gt; ~/bin/repo</span></div><div class="line">$ chmod a+x ~/bin/repo</div></pre></td></tr></table></figure></p>
<p>2、在之前创建的大小写分区上建立一个工作目录，之后源码下载和编译都在这里进行。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ mkdir WORKING_DIRECTORY</div><div class="line">$ <span class="built_in">cd</span> WORKING_DIRECTORY</div></pre></td></tr></table></figure></p>
<p>3、初始化仓库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ repo init -u git://mirrors.ustc.edu.cn/aosp/platform/manifest</div><div class="line"><span class="comment">## 如果提示无法连接到 gerrit.googlesource.com，可以编辑 ~/bin/repo，把 REPO_URL 一行替换成下面的：</span></div><div class="line"><span class="comment">## REPO_URL = 'https://gerrit-googlesource.proxy.ustclug.org/git-repo'</span></div></pre></td></tr></table></figure></p>
<p>4、选择某个特定的 Android 版本，具体查看<a href="https://source.android.com/source/build-numbers.html#source-code-tags-and-builds" target="_blank" rel="external">这里</a>,我选择的是android-5.1.1_r14，build号是LMY48M，等会用这个build号下载对应的驱动包，烧录到nexus真机时会用到。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ repo init -u git://mirrors.ustc.edu.cn/aosp/platform/manifest -b android-5.1.1_r14</div></pre></td></tr></table></figure></p>
<p>5、同步源码树<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ repo sync</div></pre></td></tr></table></figure></p>
<p>源码下载完后，如果没有同步的需求的话，就可以把<code>.repo</code>目录删掉了，防止编译时磁盘空间不够用。</p>
<h2 id="下载驱动"><a href="#下载驱动" class="headerlink" title="下载驱动"></a>下载驱动</h2><p>烧录到真机时需要用到，默认只是用模拟器的话，可以跳过这步。<br>在<a href="https://developers.google.com/android/nexus/drivers#hikey中找到对应设备与源码分支的硬件驱动。刚才选择的源码分支所对应的build码是LMY48M，因此，就下载此代号的驱动程序即可。" target="_blank" rel="external">https://developers.google.com/android/nexus/drivers#hikey中找到对应设备与源码分支的硬件驱动。刚才选择的源码分支所对应的build码是LMY48M，因此，就下载此代号的驱动程序即可。</a><br>下载得到的是三个tgz文件，我们只需依次解压三个文件，得到的是三个shell脚本文件，我们先将其置于源码根目录中。<br>依次执行这3个脚本将在源码根目录中生成一个vendor文件夹。</p>
<hr>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><h3 id="设置文件描述符限制"><a href="#设置文件描述符限制" class="headerlink" title="设置文件描述符限制"></a>设置文件描述符限制</h3><p>在macOS中，默认限制的同时打开的文件数量很少，不能满足编译过程中的高并发需要，因此需要在shell中运行命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">ulimit</span> -S -n 1024</div></pre></td></tr></table></figure></p>
<h3 id="环境设置"><a href="#环境设置" class="headerlink" title="环境设置"></a>环境设置</h3><p>在源码根目录下调用下面的命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">source</span> build/envsetup.sh</div></pre></td></tr></table></figure></p>
<h3 id="选择设备"><a href="#选择设备" class="headerlink" title="选择设备"></a>选择设备</h3><p>因为我编译后需要烧录到Nexus6上，所以选择<code>aosp_shamu-userdebug</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ lunch aosp_shamu-userdebug</div></pre></td></tr></table></figure></p>
<p>如果不需要烧录到真机上的话，用默认的<code>aosp_arm-eng</code>类型就可以了。</p>
<h3 id="开始编译"><a href="#开始编译" class="headerlink" title="开始编译"></a>开始编译</h3><p>因为本机CPU的内核是8核的，所以开16个线程加快编译。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ make -j16</div></pre></td></tr></table></figure></p>
<p>编译成功后，会有类似下面的日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#### make completed successfully (30:28:08 (hh:mm:ss)) ####</span></div></pre></td></tr></table></figure></p>
<p>编译成功的结果都在<code>out</code>目录中。<br>如果lunch的是<code>aosp_arm-eng</code>类型，就可以用<code>$ emulator</code>命令刷到模拟器了。</p>
<hr>
<h2 id="源码导入到Android-Studio中"><a href="#源码导入到Android-Studio中" class="headerlink" title="源码导入到Android Studio中"></a>源码导入到Android Studio中</h2><p>为了方便查看源码，可以把代码导入到AS中。目前看来，只能支持Java的跳转，对c++的支持不太好。<br>为了让AS理解代码的符号和源码树的结构，需要用如下命令生成一个<code>android.ipr</code>工程配置文件。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ mmm development/tools/idegen/</div><div class="line">$ development/tools/idegen/idegen.sh</div></pre></td></tr></table></figure></p>
<p>大约需要十几秒的时间，就能在源码根目录下生成android.ipr和android.iml了。<br>用AS打开android.ipr就能导入整个源码了。<br>如果要支持跳转的话，还需要做些配置，可以看这篇教程：<a href="http://blog.justain.net/index.php/import-aosp-into-android-studio/" target="_blank" rel="external">Import AOSP into Android Studio</a></p>
<hr>
<h2 id="刷机"><a href="#刷机" class="headerlink" title="刷机"></a>刷机</h2><p>Nexus6手机在打开USB调试，连接电脑后允许调试这台手机，并且在设置中打开“允许 OEM 解锁”。然后令手机进入recovery模式，在关机下，输入如下命令即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ adb reboot bootloader</div></pre></td></tr></table></figure></p>
<p>执行如下命令刷机：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ fastboot -w flashall</div></pre></td></tr></table></figure></p>
<p>刷机成功后，手机会自动重启，新鲜出炉的系统终于跑起来了。<br>刷机过程中也出现过变砖的情况，可以试一下<a href="http://www.shuame.com/faq/restore-tutorial/14679-google-nexus6.html" target="_blank" rel="external">这个教程</a>，亲测有效。</p>
<hr>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><p><a href="https://medium.com/@raminmahmoodi/build-android-5-0-lollipop-on-osx-10-10-yosemite-441bd00ee77a" target="_blank" rel="external">Build Android 5.0 Lollipop on OSX 10.10 Yosemite</a><br><a href="http://blog.bihe0832.com/macOS-AOSP.html" target="_blank" rel="external">http://blog.bihe0832.com/macOS-AOSP.html</a><br><a href="http://boxingp.github.io/blog/2015/01/25/manage-multiple-versions-of-java-on-os-x/" target="_blank" rel="external">在OS X中使用jEnv管理多个Java版本</a><br><a href="http://blog.justain.net/index.php/import-aosp-into-android-studio/" target="_blank" rel="external">Import AOSP into Android Studio</a><br><a href="http://www.shuame.com/faq/restore-tutorial/14679-google-nexus6.html" target="_blank" rel="external">Nexus 6 恢复官方兼救砖</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://The-Coderz.github.io/2017/04/16/在macOS 10.12 上编译 Android 5.1/" data-id="cj1kekdp3000tb7ahu1uwwnse" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-xlog接入方案" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/16/xlog接入方案/" class="article-date">
  <time datetime="2017-04-16T07:54:55.000Z" itemprop="datePublished">2017-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/16/xlog接入方案/">xlog接入方案</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/Tencent/mars" target="_blank" rel="external">mars</a> 是微信最近开源的终端基础组件，是一个使用 C++ 编写的基础组件。<br>xlog是其中一个可单独使用的高性能日志模块。<br>本文将简单介绍下xlog的特点，并给出一个自定义的输出到文件的策略。</p>
<hr>
<h2 id="xlog的特点"><a href="#xlog的特点" class="headerlink" title="xlog的特点"></a>xlog的特点</h2><p>使用流式压缩方式对单行日志进行压缩，压缩加密后写进作为 log 中间 buffer的 mmap 中，当 mmap 中的数据到达一定大小后再写进磁盘文件中。<br><img src="http://ww4.sinaimg.cn/large/8b331ee1gw1fbmxsvozhbj20jg08iglr.jpg" alt=""><br><img src="http://ww3.sinaimg.cn/large/8b331ee1gw1fbmxtm3kajj20kp04caa7.jpg" alt=""></p>
<p>输出到文件的主要实现是在 Appender 模块也是可插拔的，如果对默认的策略不满意可以自己实现一套。<br><img src="http://ww3.sinaimg.cn/large/8b331ee1gw1fblriu5wrqj20ci0630sv.jpg" alt=""></p>
<p>xlog还存在一些其他策略：</p>
<ul>
<li>每次启动的时候会清理日志，防止占用太多用户磁盘空间</li>
<li>为了防止 sdcard 被拔掉导致写不了日志，支持设置缓存目录，当 sdcard 插上时会把缓存目录里的日志写入到 sdcard 上</li>
</ul>
<p>从下面的log2file流程图中可以看出xlog是如何利用cahce目录解决插拔sdcard的问题的。<br><code>log2file流程图</code><br><img src="http://ww4.sinaimg.cn/large/8b331ee1gw1fbmlojbj7dj210i19648b.jpg" alt=""></p>
<h3 id="上一次没写完的日志，如何重新写到日志中"><a href="#上一次没写完的日志，如何重新写到日志中" class="headerlink" title="上一次没写完的日志，如何重新写到日志中"></a>上一次没写完的日志，如何重新写到日志中</h3><p>在日志模块初始化会执行如下的代码，sg_log_buff为与mmap文件映射的逻辑内存，这里会主动调用Flush，把mmap文件中的数据（即上一次没写到日志文件中的日志）fluse到buffer中，并调用__log2file写到日志文件中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> mmap_file_path[<span class="number">512</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line"><span class="built_in">snprintf</span>(mmap_file_path, <span class="keyword">sizeof</span>(mmap_file_path), <span class="string">"%s/%s.mmap2"</span>, sg_cache_logdir.empty()?_dir:sg_cache_logdir.c_str(), _nameprefix);</div><div class="line"></div><div class="line">    <span class="keyword">bool</span> use_mmap = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">if</span> (OpenMmapFile(mmap_file_path, kBufferBlockLength, sg_mmmap_file))  &#123;</div><div class="line">        sg_log_buff = <span class="keyword">new</span> LogBuffer(sg_mmmap_file.data(), kBufferBlockLength, <span class="literal">true</span>);</div><div class="line">        use_mmap = <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">    AutoBuffer buffer;</div><div class="line">    sg_log_buff-&gt;Flush(buffer); <span class="comment">// 把mmap文件中日志信息flush到内存中，下面调用__log2file写到文件中。</span></div><div class="line">    <span class="keyword">if</span> (buffer.Ptr()) &#123;</div><div class="line">        __writetips2file(<span class="string">"~~~~~ begin of mmap ~~~~~\n"</span>);</div><div class="line">        __log2file(buffer.Ptr(), buffer.Length());</div><div class="line">        __writetips2file(<span class="string">"~~~~~ end of mmap ~~~~~%s\n"</span>, mark_info);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="修改xlog默认的输出到文件的策略"><a href="#修改xlog默认的输出到文件的策略" class="headerlink" title="修改xlog默认的输出到文件的策略"></a>修改xlog默认的输出到文件的策略</h2><h3 id="xlog默认的策略"><a href="#xlog默认的策略" class="headerlink" title="xlog默认的策略"></a>xlog默认的策略</h3><p>每次启动时会删除过期文件，只保留十天内的日志文件(该值定义在appender.cc中的 kMaxLogAliveTime )，所以给 Xlog 的目录请使用单独目录，防止误删其他文件。目前不会根据文件大小进行清理。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __del_timeout_file(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; _log_path) &#123;</div><div class="line">    <span class="keyword">time_t</span> now_time = time(<span class="literal">NULL</span>);</div><div class="line">    </div><div class="line">    boost::filesystem::<span class="function">path <span class="title">path</span><span class="params">(_log_path)</span></span>;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (boost::filesystem::exists(path) &amp;&amp; boost::filesystem::is_directory(path))&#123;</div><div class="line">        boost::filesystem::directory_iterator end_iter;</div><div class="line">        <span class="keyword">for</span> (boost::filesystem::directory_iterator iter(path); iter != end_iter; ++iter) &#123;</div><div class="line">            <span class="keyword">time_t</span> fileModifyTime = boost::filesystem::last_write_time(iter-&gt;path());</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (now_time &gt; fileModifyTime &amp;&amp; now_time - fileModifyTime &gt; kMaxLogAliveTime) &#123;</div><div class="line">                <span class="keyword">if</span> (boost::filesystem::is_regular_file(iter-&gt;status())) &#123;</div><div class="line">                    boost::filesystem::remove(iter-&gt;path());</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (boost::filesystem::is_directory(iter-&gt;status())) &#123;</div><div class="line">                    __del_files(iter-&gt;path().<span class="built_in">string</span>());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>日志文件是按天命名的，每天产生一个日志文件。<br>在<code>__openlogfile</code>、<code>__log2file</code>中会调用。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __make_logfilename(<span class="keyword">const</span> timeval&amp; _tv, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; _logdir, <span class="keyword">const</span> <span class="keyword">char</span>* _prefix, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; _fileext, <span class="keyword">char</span>* _filepath, <span class="keyword">unsigned</span> <span class="keyword">int</span> _len) &#123;</div><div class="line">    <span class="keyword">time_t</span> sec = _tv.tv_sec;</div><div class="line">    tm tcur = *localtime((<span class="keyword">const</span> <span class="keyword">time_t</span>*)&amp;sec);</div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> logfilepath = _logdir;</div><div class="line">    logfilepath += <span class="string">"/"</span>;</div><div class="line">    logfilepath += _prefix;</div><div class="line">    <span class="keyword">char</span> temp [<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line">    <span class="built_in">snprintf</span>(temp, <span class="number">64</span>, <span class="string">"_%d%02d%02d"</span>, <span class="number">1900</span> + tcur.tm_year, <span class="number">1</span> + tcur.tm_mon, tcur.tm_mday);</div><div class="line">    logfilepath += temp;</div><div class="line">    logfilepath += <span class="string">"."</span>;</div><div class="line">    logfilepath += _fileext;</div><div class="line">    <span class="built_in">strncpy</span>(_filepath, logfilepath.c_str(), _len - <span class="number">1</span>);</div><div class="line">    _filepath[_len - <span class="number">1</span>] = <span class="string">'\0'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>比如在2017年01月10号的日志会写到LOG_20170110.log文件中，到2017年01月11号时，日志写到LOG_20170111.log，依次类推。过期的日志文件会在日志模块初始化时被清理掉。</p>
<h3 id="改写输出到文件的策略"><a href="#改写输出到文件的策略" class="headerlink" title="改写输出到文件的策略"></a>改写输出到文件的策略</h3><p>xlog输出的文件的逻辑都在<code>appender.cc</code>中实现，可以修改这里的代码实现一套自己的策略。<br>比如想要控制日志文件的大小，即Rotating file based on size的策略。<br>这里的实现方案并不支持cachedir。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">bool</span> __writefile(<span class="keyword">const</span> <span class="keyword">void</span>* _data, <span class="keyword">size_t</span> _len) &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == sg_logfile) &#123;</div><div class="line">        assert(<span class="literal">false</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">long</span> before_len = ftell(sg_logfile);</div><div class="line">    <span class="keyword">if</span> (before_len &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 如果发生了__roate，需要reopen sg_logfile</span></div><div class="line">    <span class="keyword">if</span>(before_len+_len &gt; sg_max_size)&#123;</div><div class="line">        <span class="keyword">if</span>(!__roate())&#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="number">1</span> != fwrite(_data, _len, <span class="number">1</span>, sg_logfile)) &#123;</div><div class="line">        <span class="keyword">int</span> err = ferror(sg_logfile);</div><div class="line"></div><div class="line">        __writetips2console(<span class="string">"write file error:%d"</span>, err);</div><div class="line"></div><div class="line"></div><div class="line">        ftruncate(fileno(sg_logfile), before_len);</div><div class="line">        fseek(sg_logfile, <span class="number">0</span>, SEEK_END);</div><div class="line"></div><div class="line">        <span class="keyword">char</span> err_log[<span class="number">256</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line">        <span class="built_in">snprintf</span>(err_log, <span class="keyword">sizeof</span>(err_log), <span class="string">"\nwrite file error:%d\n"</span>, err);</div><div class="line"></div><div class="line">        <span class="keyword">char</span> tmp[<span class="number">256</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line">        <span class="keyword">size_t</span> len = <span class="keyword">sizeof</span>(tmp);</div><div class="line">        LogBuffer::Write(err_log, strnlen(err_log, <span class="keyword">sizeof</span>(err_log)), tmp, len);</div><div class="line"></div><div class="line">        fwrite(tmp, len, <span class="number">1</span>, sg_logfile);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">NumberToString</span> <span class="params">( T Number )</span></span></div><div class="line">&#123;</div><div class="line">     <span class="built_in">std</span>::<span class="built_in">ostringstream</span> ss;</div><div class="line">     ss &lt;&lt; Number;</div><div class="line">     <span class="keyword">return</span> ss.str();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">string</span> __calc_filename(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; _logdir, <span class="keyword">const</span> <span class="keyword">char</span>* _prefix, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; _fileext,<span class="keyword">unsigned</span> <span class="keyword">int</span> index)&#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> logfilepath = _logdir;</div><div class="line">    logfilepath += <span class="string">"/"</span>;</div><div class="line">    logfilepath += _prefix;</div><div class="line">    <span class="keyword">if</span>(index)&#123;</div><div class="line">        logfilepath += <span class="string">"."</span>;</div><div class="line">        logfilepath += NumberToString(index);</div><div class="line">    &#125;</div><div class="line">    logfilepath += <span class="string">"."</span>;</div><div class="line">    logfilepath += _fileext;</div><div class="line">    <span class="keyword">return</span> logfilepath;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// Rotate files:</span></div><div class="line">    <span class="comment">// log.txt -&gt; log.1.txt</span></div><div class="line">    <span class="comment">// log.1.txt -&gt; log2.txt</span></div><div class="line">    <span class="comment">// log.2.txt -&gt; log3.txt</span></div><div class="line">    <span class="comment">// log.3.txt -&gt; delete</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">bool</span> __roate()&#123;</div><div class="line">    <span class="keyword">if</span>(sg_logfilename.empty() || sg_logdir.empty() || sg_logfileprefix.empty())&#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fclose(sg_logfile);</div><div class="line">    sg_logfile = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> i = sg_max_files; i &gt; <span class="number">0</span>; --i)&#123;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> src = __calc_filename(sg_logdir,sg_logfileprefix.c_str(),LOG_EXT,i<span class="number">-1</span>);</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> target = __calc_filename(sg_logdir,sg_logfileprefix.c_str(),LOG_EXT,i);</div><div class="line">        boost::filesystem::<span class="function">path <span class="title">src_path</span><span class="params">(src)</span></span>;</div><div class="line">        boost::filesystem::<span class="function">path <span class="title">target_path</span><span class="params">(target)</span></span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(boost::filesystem::exists(target_path))&#123;</div><div class="line">            boost::filesystem::remove(target_path);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(boost::filesystem::exists(src_path))&#123;</div><div class="line">            boost::filesystem::rename(src_path,target_path);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//reopen</span></div><div class="line">    sg_logfile = fopen(sg_logfilename.c_str(), <span class="string">"wb"</span>);</div><div class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == sg_logfile) &#123;</div><div class="line">        __writetips2console(<span class="string">"open file error:%d %s, path:%s"</span>, errno, strerror(errno), sg_logfilename.c_str());</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">bool</span> __openlogfile(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; _log_dir)&#123;</div><div class="line">    <span class="keyword">if</span> (sg_logdir.empty()) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 如果sg_logfile已经打开了，则直接返回。</span></div><div class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != sg_logfile) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sg_current_dir = _log_dir;</div><div class="line">    sg_logfilename = __calc_filename(_log_dir, sg_logfileprefix.c_str(), LOG_EXT,<span class="number">0</span>);</div><div class="line"></div><div class="line">    sg_logfile = fopen(sg_logfilename.c_str(), <span class="string">"ab"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == sg_logfile) &#123;</div><div class="line">        __writetips2console(<span class="string">"open file error:%d %s, path:%s"</span>, errno, strerror(errno), sg_logfilename.c_str());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span> != sg_logfile;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __log2file(<span class="keyword">const</span> <span class="keyword">void</span>* _data, <span class="keyword">size_t</span> _len) &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == _data || <span class="number">0</span> == _len || sg_logdir.empty()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	    <span class="function">ScopedLock <span class="title">lock_file</span><span class="params">(sg_mutex_log_file)</span></span>;</div><div class="line">        <span class="keyword">if</span> (__openlogfile(sg_logdir)) &#123;</div><div class="line">            __writefile(_data, _len);</div><div class="line">            <span class="keyword">if</span> (kAppednerAsync == sg_mode) &#123;</div><div class="line">                __closelogfile();</div><div class="line">            &#125;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码详见：<a href="https://github.com/FelixZhang00/xlog-rotating-base-size" target="_blank" rel="external">github</a></p>
<hr>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><p><a href="http://dev.qq.com/topic/581c2c46bef1702a2db3ae53" target="_blank" rel="external">http://dev.qq.com/topic/581c2c46bef1702a2db3ae53</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://The-Coderz.github.io/2017/04/16/xlog接入方案/" data-id="cj1kekdp0000rb7ahnz68vc5h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c-开源代码/">c++ 开源代码</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-spdlog源码学习" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/16/spdlog源码学习/" class="article-date">
  <time datetime="2017-04-16T07:54:55.000Z" itemprop="datePublished">2017-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/16/spdlog源码学习/">spdlog源码学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/gabime/spdlog" target="_blank" rel="external">spdlog</a>是一个用c++11实现的高性能日志库。<br>接入方便，功能丰富，代码可读性较高。</p>
<hr>
<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><ul>
<li>Very fast - performance is the primary goal </li>
<li>Headers only, just copy and use.</li>
<li>Feature rich  using the excellent <a href="https://github.com/fmtlib/fmt" target="_blank" rel="external">fmt</a> library.</li>
<li>Extremely fast asynchronous mode (optional) - using lockfree queues and other tricks to reach millions of calls/sec.</li>
<li><a href="https://github.com/gabime/spdlog/wiki/3.-Custom-formatting" target="_blank" rel="external">Custom</a> formatting.</li>
<li>Multi/Single threaded loggers.</li>
<li>Various log targets:<ul>
<li>Rotating log files.</li>
<li>Daily log files.</li>
<li>Console logging (colors supported).</li>
<li>syslog.</li>
<li>Windows debugger </li>
<li>Easily extendable with custom log targets  (just implement a single function in the sink interface).</li>
</ul>
</li>
<li>Severity based filtering - threshold levels can be modified in runtime as well as in compile time.</li>
</ul>
<hr>
<h2 id="核心设计"><a href="#核心设计" class="headerlink" title="核心设计"></a>核心设计</h2><p>spdlog中定义了一系列Sink类，作为实际上把log输出到指定目标的对象，每一个Sink唯一对应一个log的输出目标（如console、文件、db）.<br>每一个logger包含一个sink列表，每当上层调用logger的log方法写日志时，logger就会调用sink列表中的每一个sink的 <code>sink(log_msg)</code> 函数，真正往目标中写日志。</p>
<h3 id="实现Rotating-file写日志"><a href="#实现Rotating-file写日志" class="headerlink" title="实现Rotating file写日志"></a>实现Rotating file写日志</h3><p>当前正在写日志的文件名一直都是log.txt。<br>当log.txt写不下时，把它重命名为log1.txt,再重新打开一个log.txt文件。<br>多个文件循环也依次类推。</p>
<pre><code>// Rotate files:
// log.txt -&gt; log.1.txt
// log.1.txt -&gt; log2.txt
// log.2.txt -&gt; log3.txt
// log.3.txt -&gt; delete
</code></pre><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Rotating file sink based on size</div><div class="line"> */</div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Mutex&gt;</div><div class="line"><span class="keyword">class</span> rotating_file_sink : <span class="keyword">public</span> base_sink &lt; Mutex &gt;</div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    rotating_file_sink(<span class="keyword">const</span> <span class="keyword">filename_t</span> &amp;base_filename, <span class="keyword">const</span> <span class="keyword">filename_t</span> &amp;extension,</div><div class="line">                       <span class="built_in">std</span>::<span class="keyword">size_t</span> max_size, <span class="built_in">std</span>::<span class="keyword">size_t</span> max_files                       ) :</div><div class="line">    &#123;</div><div class="line">        _file_helper.open(calc_filename(_base_filename, <span class="number">0</span>, _extension));</div><div class="line">        _current_size = _file_helper.size(); <span class="comment">//expensive. called only once</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span>:</div><div class="line">    <span class="keyword">void</span> _sink_it(<span class="keyword">const</span> details::log_msg&amp; msg) override</div><div class="line">    &#123;</div><div class="line">        _current_size += msg.formatted.size();</div><div class="line">        <span class="keyword">if</span> (_current_size &gt; _max_size)</div><div class="line">        &#123;</div><div class="line">            _rotate();</div><div class="line">            _current_size = msg.formatted.size();</div><div class="line">        &#125;</div><div class="line">        _file_helper.write(msg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="function"><span class="keyword">static</span> filename_t <span class="title">calc_filename</span><span class="params">(<span class="keyword">const</span> <span class="keyword">filename_t</span>&amp; filename, <span class="built_in">std</span>::<span class="keyword">size_t</span> index, <span class="keyword">const</span> <span class="keyword">filename_t</span>&amp; extension)</span></span></div><div class="line">    &#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">        <span class="keyword">return</span> w.str();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> _rotate()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">using</span> details::os::filename_to_str;</div><div class="line">        _file_helper.close();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> i = _max_files; i &gt; <span class="number">0</span>; --i)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">filename_t</span> src = calc_filename(_base_filename, i - <span class="number">1</span>, _extension);</div><div class="line">            <span class="keyword">filename_t</span> target = calc_filename(_base_filename, i, _extension);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (details::file_helper::file_exists(target))</div><div class="line">            &#123;</div><div class="line">                details::os::remove(target);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (details::file_helper::file_exists(src) &amp;&amp; details::os::rename(src, target))</div><div class="line">            &#123;</div><div class="line">				<span class="comment">//...</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        _file_helper.reopen(<span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">filename_t</span> _base_filename;</div><div class="line">    <span class="keyword">filename_t</span> _extension;</div><div class="line">    <span class="built_in">std</span>::<span class="keyword">size_t</span> _max_size;</div><div class="line">    <span class="built_in">std</span>::<span class="keyword">size_t</span> _max_files;</div><div class="line">    <span class="built_in">std</span>::<span class="keyword">size_t</span> _current_size;</div><div class="line">    details::file_helper _file_helper;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<hr>
<h3 id="实现异步写日志"><a href="#实现异步写日志" class="headerlink" title="实现异步写日志"></a>实现异步写日志</h3><p>所有异步写日志的请求都会被push到一个固定大小的队列中。<br>有一个工作线程会不停的从队列中pop一条日志消息，并最终写到日志中。</p>
<p>调用方：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">async_example</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">size_t</span> q_size = <span class="number">4096</span>; <span class="comment">//queue size must be power of 2</span></div><div class="line">    spdlog::set_async_mode(q_size);</div><div class="line">    <span class="keyword">auto</span> async_file = spd::daily_logger_st(<span class="string">"async_file_logger"</span>, <span class="string">"logs/async_log.txt"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i)</div><div class="line">        async_file-&gt;info(<span class="string">"Async message #&#123;&#125;"</span>, i);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>具体实现：<br>开启一个工作线程，在async_log初始时就开始工作了。并且在析构是被关闭<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Async Logger implementation</span></div><div class="line"><span class="comment">// Use an async_sink (queue per logger) to perform the logging in a worker thread</span></div><div class="line"></div><div class="line"><span class="comment">//一个工作线程，在async_log初始时就开始工作了。并且在析构是被关闭</span></div><div class="line"><span class="comment">// worker thread</span></div><div class="line"><span class="built_in">std</span>::thread _worker_thread;</div><div class="line">_worker_thread(&amp;async_log_helper::worker_loop, <span class="keyword">this</span>)</div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span> spdlog::details::async_log_helper::worker_loop()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (_worker_warmup_cb) _worker_warmup_cb();</div><div class="line">        <span class="keyword">auto</span> last_pop = details::os::now();</div><div class="line">        <span class="keyword">auto</span> last_flush = last_pop;</div><div class="line">        <span class="keyword">while</span>(process_next_msg(last_pop, last_flush));</div><div class="line">        <span class="keyword">if</span> (_worker_teardown_cb) _worker_teardown_cb();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (<span class="keyword">const</span> <span class="built_in">std</span>::exception &amp;ex)</div><div class="line">    &#123;</div><div class="line">        _err_handler(ex.what());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (...)</div><div class="line">    &#123;</div><div class="line">        _err_handler(<span class="string">"Unknown exception"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// Send to the worker thread termination message(level=off)</span></div><div class="line"><span class="comment">// and wait for it to finish gracefully</span></div><div class="line"><span class="keyword">inline</span> spdlog::details::async_log_helper::~async_log_helper()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        push_msg(async_msg(async_msg_type::terminate));</div><div class="line">        _worker_thread.join();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (...) <span class="comment">// don't crash in destructor</span></div><div class="line">    &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从队列中取消息，如果是写日志的消息，则调用sink写日志。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//从队列中取消息，如果是写日志的消息，则调用sink写日志。</span></div><div class="line"><span class="comment">// process next message in the queue</span></div><div class="line"><span class="comment">// return true if this thread should still be active (while no terminate msg was received)</span></div><div class="line"><span class="keyword">inline</span> <span class="keyword">bool</span> spdlog::details::async_log_helper::process_next_msg(log_clock::time_point&amp; last_pop, log_clock::time_point&amp; last_flush)</div><div class="line">&#123;</div><div class="line">    async_msg incoming_async_msg;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (_q.dequeue(incoming_async_msg))</div><div class="line">    &#123;</div><div class="line">        last_pop = details::os::now();</div><div class="line">        <span class="keyword">switch</span> (incoming_async_msg.msg_type)</div><div class="line">        &#123;</div><div class="line">        <span class="keyword">case</span> async_msg_type::flush:</div><div class="line">            _flush_requested = <span class="literal">true</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> async_msg_type::terminate:</div><div class="line">            _flush_requested = <span class="literal">true</span>;</div><div class="line">            _terminate_requested = <span class="literal">true</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            log_msg incoming_log_msg;</div><div class="line">            incoming_async_msg.fill_log_msg(incoming_log_msg);</div><div class="line">            _formatter-&gt;format(incoming_log_msg);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;s : _sinks)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span>(s-&gt;should_log( incoming_log_msg.level))</div><div class="line">                &#123;</div><div class="line">                    s-&gt;<span class="built_in">log</span>(incoming_log_msg);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Handle empty queue..</span></div><div class="line">    <span class="comment">// This is the only place where the queue can terminate or flush to avoid losing messages already in the queue</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">auto</span> now = details::os::now();</div><div class="line">        handle_flush_interval(now, last_flush);</div><div class="line">        sleep_or_yield(now, last_pop);</div><div class="line">        <span class="keyword">return</span> !_terminate_requested;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用写日志，往队列里塞一条写日志消息。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span> spdlog::logger::<span class="built_in">log</span>(level::level_enum lvl, <span class="keyword">const</span> T&amp; msg)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!should_log(lvl)) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        details::<span class="function">log_msg <span class="title">log_msg</span><span class="params">(&amp;_name, lvl)</span></span>;</div><div class="line">        log_msg.raw &lt;&lt; msg;</div><div class="line">        _sink_it(log_msg);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (<span class="keyword">const</span> <span class="built_in">std</span>::exception &amp;ex)</div><div class="line">    &#123;</div><div class="line">        _err_handler(ex.what());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (...)</div><div class="line">    &#123;</div><div class="line">        _err_handler(<span class="string">"Unknown exception"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span> spdlog::async_logger::_sink_it(details::log_msg&amp; msg)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        _async_log_helper-&gt;<span class="built_in">log</span>(msg);</div><div class="line">        <span class="keyword">if</span> (_should_flush_on(msg))</div><div class="line">            _async_log_helper-&gt;flush(<span class="literal">false</span>); <span class="comment">// do async flush</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (<span class="keyword">const</span> <span class="built_in">std</span>::exception &amp;ex)</div><div class="line">    &#123;</div><div class="line">        _err_handler(ex.what());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (...)</div><div class="line">    &#123;</div><div class="line">        _err_handler(<span class="string">"Unknown exception"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 往队列里塞一条日志进去，准备被写</span></div><div class="line"><span class="comment">//Try to push and block until succeeded (if the policy is not to discard when the queue is full)</span></div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span> spdlog::details::async_log_helper::<span class="built_in">log</span>(<span class="keyword">const</span> details::log_msg&amp; msg)</div><div class="line">&#123;</div><div class="line">    push_msg(async_msg(msg));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span> spdlog::details::async_log_helper::push_msg(details::async_log_helper::async_msg&amp;&amp; new_msg)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!_q.enqueue(<span class="built_in">std</span>::move(new_msg)) &amp;&amp; _overflow_policy != async_overflow_policy::discard_log_msg)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">auto</span> last_op_time = details::os::now();</div><div class="line">        <span class="keyword">auto</span> now = last_op_time;</div><div class="line">        <span class="keyword">do</span></div><div class="line">        &#123;</div><div class="line">            now = details::os::now();</div><div class="line">            sleep_or_yield(now, last_op_time);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">while</span> (!_q.enqueue(<span class="built_in">std</span>::move(new_msg)));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>根据时间间隔让线程等待<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// spin, yield or sleep. use the time passed since last message as a hint</span></div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span> spdlog::details::async_log_helper::sleep_or_yield(<span class="keyword">const</span> spdlog::log_clock::time_point&amp; now, <span class="keyword">const</span> spdlog::log_clock::time_point&amp; last_op_time)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>::this_thread;</div><div class="line">    <span class="keyword">using</span> <span class="built_in">std</span>::chrono::milliseconds;</div><div class="line">    <span class="keyword">using</span> <span class="built_in">std</span>::chrono::microseconds;</div><div class="line"></div><div class="line">    <span class="keyword">auto</span> time_since_op = now - last_op_time;</div><div class="line"></div><div class="line">    <span class="comment">// spin upto 50 micros</span></div><div class="line">    <span class="keyword">if</span> (time_since_op &lt;= microseconds(<span class="number">50</span>))</div><div class="line">        <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="comment">// yield upto 150 micros</span></div><div class="line">    <span class="keyword">if</span> (time_since_op &lt;= microseconds(<span class="number">100</span>))</div><div class="line">        <span class="keyword">return</span> <span class="built_in">std</span>::this_thread::yield();</div><div class="line"></div><div class="line">    <span class="comment">// sleep for 20 ms upto 200 ms</span></div><div class="line">    <span class="keyword">if</span> (time_since_op &lt;= milliseconds(<span class="number">200</span>))</div><div class="line">        <span class="keyword">return</span> sleep_for(milliseconds(<span class="number">20</span>));</div><div class="line"></div><div class="line">    <span class="comment">// sleep for 200 ms</span></div><div class="line">    <span class="keyword">return</span> sleep_for(milliseconds(<span class="number">200</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://The-Coderz.github.io/2017/04/16/spdlog源码学习/" data-id="cj1kekdoy000pb7ah64bffuw1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c-开源代码/">c++ 开源代码</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2017-01-08-cobertura" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/08/2017-01-08-cobertura/" class="article-date">
  <time datetime="2017-01-08T07:14:31.000Z" itemprop="datePublished">2017-01-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/08/2017-01-08-cobertura/">【2017-01-08 cobertura】</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="cobertura"><a href="#cobertura" class="headerlink" title="cobertura"></a>cobertura</h2><h3 id="cobertura-website"><a href="#cobertura-website" class="headerlink" title="cobertura website"></a><a href="http://cobertura.sourceforge.net/" target="_blank" rel="external">cobertura website</a></h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cobertura是一个用于分析Java单测覆盖率的工具，我按照自己maven工程配置，来说下吧。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>也不知道为什么，反正我官网没有打开过，资料也不多</strong></p>
<hr>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://www.mojohaus.org/cobertura-maven-plugin/" target="_blank" rel="external">apache maven plugin</a>，这个可以打开😂。</p>
<h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;plugin&gt;</div><div class="line">  &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;</div><div class="line">  &lt;artifactId&gt;cobertura-maven-plugin&lt;/artifactId&gt;</div><div class="line">  &lt;version&gt;$&#123;cobertura.version&#125;&lt;/version&gt;</div><div class="line">  &lt;configuration&gt;</div><div class="line">    &lt;instrumentation&gt;</div><div class="line">      &lt;includes&gt;			// 规定计算哪一部分的单测覆盖率，如DAO的覆盖率没必要计算</div><div class="line">        &lt;include&gt;com/van/service/**/*.class&lt;/include&gt;</div><div class="line">      &lt;/includes&gt;</div><div class="line">    &lt;/instrumentation&gt;</div><div class="line">  &lt;/configuration&gt;</div><div class="line">&lt;/plugin&gt;</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 按照上面的pom配置，cobertura只会计算com.van.service.**.*.class的单测覆盖率。同理，还可以配置<excludes>标签来排除不需要计算的类。  </excludes></p>
<h3 id="计算"><a href="#计算" class="headerlink" title="计算"></a>计算</h3><p><code>mvn -B cobertura:cobertura -Dmaven.test.failure.ignore=true</code><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  执行上述命令，会在对应的targe/sit/cobertura/下生成需要的内容，打开对应的index.html即可以看到单测覆盖率。    </p>
<center><br><img src="/images/2017/01/08/cobertura执行.png" alt="cobertura命令执行"><br><br><img src="/images/2017/01/08/cobertura统计结果.png" alt="cobertura统计结果"><br></center>

<h3 id="值得注意"><a href="#值得注意" class="headerlink" title="值得注意"></a>值得注意</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 值得注意的是，在我自己的测试(mavne:3, cobertura-maven-plugin:5.0.2)和stack overflow上的提问中，都有类似的情况：cobertura的<ignore>标签在maven中似乎没有什么作用，不过有<include>、<exclude>应该也能满足要求。<br><a href="http://stackoverflow.com/questions/25900958/cobertura-exclude-vs-ignore" target="_blank" rel="external">stack overflow - cobertura-exclude-vs-ignore</a></exclude></include></ignore></p>
<center><br><img src="/images/2017/01/08/stackoverflow-cobertura-ignore-vs-exclude.png" alt="cobertura stack overflow ignore vs exclude"><br></center>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://The-Coderz.github.io/2017/01/08/2017-01-08-cobertura/" data-id="cj1kekdoi000db7ahpopve6ca" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Python断点调试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/08/Python断点调试/" class="article-date">
  <time datetime="2017-01-08T06:42:43.000Z" itemprop="datePublished">2017-01-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/08/Python断点调试/">Python断点调试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>很多项目是用python写构建脚本的，比如微信最近开源的终端跨平台组件 <a href="https://github.com/Tencent/mars" target="_blank" rel="external">Mars</a><br>本文将以mars为例简单介绍下如何用<a href="https://www.jetbrains.com/pycharm/" target="_blank" rel="external">PyCharm</a>对python进行断点调试。</p>
<hr>
<h3 id="导入代码"><a href="#导入代码" class="headerlink" title="导入代码"></a>导入代码</h3><p>open整个mars项目，切换合适的python版本，mars需要python2.7版本。<br><img src="http://ww1.sinaimg.cn/large/8b331ee1gw1fbifkuh496j20h81f0q9j.jpg" alt=""><br><img src="http://ww2.sinaimg.cn/large/8b331ee1gw1fbifke5anpj20xm0du0xi.jpg" alt=""></p>
<h3 id="打断点"><a href="#打断点" class="headerlink" title="打断点"></a>打断点</h3><p><img src="http://ww3.sinaimg.cn/large/8b331ee1gw1fbifnm18q9j20gk04gt94.jpg" alt=""></p>
<h3 id="Debug-it"><a href="#Debug-it" class="headerlink" title="Debug it"></a>Debug it</h3><p><img src="http://ww1.sinaimg.cn/large/8b331ee1gw1fbifo65ncyj20po0v6wm7.jpg" alt=""></p>
<p>当代码中需要input时，切换到Console窗口输入<br><img src="http://ww3.sinaimg.cn/large/8b331ee1gw1fbifq7bsxlj20nm0e4jvb.jpg" alt=""></p>
<p><img src="http://ww3.sinaimg.cn/large/8b331ee1gw1fbifqp5rcaj211q0lutf5.jpg" alt=""></p>
<p>用PyCharm调试跟Android Studio一样，毕竟都是一家公司的产品。</p>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://The-Coderz.github.io/2017/01/08/Python断点调试/" data-id="cj1kekdom000hb7ahiaa6dhsv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/工具-python/">工具 python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Stetho工具介绍" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/08/Stetho工具介绍/" class="article-date">
  <time datetime="2017-01-08T06:42:43.000Z" itemprop="datePublished">2017-01-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/08/Stetho工具介绍/">Stetho工具介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://facebook.github.io/stetho/" target="_blank" rel="external">stetho</a>是Facebook推出的安卓APP网络诊断和数据监控的工具，接入方便，功能强大，是开发者必备的好工具。</p>
<p>主要功能包括：</p>
<ul>
<li>查看App的布局</li>
<li>网络请求抓包</li>
<li>数据库、sp文件查看</li>
<li>自定义dumpapp插件</li>
<li>对于JavaScript的支持</li>
</ul>
<p>无需root，只要能通过adb连接设备，操作方便。</p>
<h2 id="接入方法"><a href="#接入方法" class="headerlink" title="接入方法"></a>接入方法</h2><h3 id="gradle配置"><a href="#gradle配置" class="headerlink" title="gradle配置"></a>gradle配置</h3><p>因为目前我们的项目中已经集成了okhttp，只需要在build.gradle添加如下两行配置</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">   <span class="comment">//...</span></div><div class="line"></div><div class="line">   compile <span class="string">'com.facebook.stetho:stetho-js-rhino:1.3.1'</span></div><div class="line">   compile <span class="string">'com.facebook.stetho:stetho-okhttp3:1.4.2'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>在Application类中完成初始化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MyApplicationCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// ...</span></div><div class="line">     Stetho.initializeWithDefaults(mContext);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h2 id="使用功能"><a href="#使用功能" class="headerlink" title="使用功能"></a>使用功能</h2><ol>
<li>adb方式连接到设备</li>
<li>运行debug模式的app</li>
<li>在Chrome浏览器地址栏中输入chrome://inspect</li>
<li>选择需要inspect的应用进程<br><img src="http://ww1.sinaimg.cn/large/8b331ee1gw1fbg4wwn5ftj21aw0qo7az.jpg" alt=""></li>
</ol>
<h3 id="查看App的布局"><a href="#查看App的布局" class="headerlink" title="查看App的布局"></a>查看App的布局</h3><p><img src="http://ww1.sinaimg.cn/large/8b331ee1gw1fbfhku1ltsj21kw0s5tt8.jpg" alt=""></p>
<h3 id="网络诊断"><a href="#网络诊断" class="headerlink" title="网络诊断"></a>网络诊断</h3><p>给OkHttpClient添加拦截器。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> OkHttpClient.Builder()</div><div class="line">    .addNetworkInterceptor(<span class="keyword">new</span> StethoInterceptor())</div><div class="line">    .build();</div></pre></td></tr></table></figure></p>
<p>主要功能有包括下载图片的预览，JSON数据查看，网络请求内容和返回内容<br><img src="http://ww3.sinaimg.cn/large/8b331ee1gw1fbfhpn53jjj21kw0rjk3j.jpg" alt=""></p>
<h3 id="数据库、sp文件查看"><a href="#数据库、sp文件查看" class="headerlink" title="数据库、sp文件查看"></a>数据库、sp文件查看</h3><p><img src="http://ww4.sinaimg.cn/large/8b331ee1gw1fbfhrmo7blj21kw0rvgx0.jpg" alt=""></p>
<p><img src="http://ww3.sinaimg.cn/large/8b331ee1gw1fbfhsqtl35j21kw0rq7fi.jpg" alt=""></p>
<h3 id="自定义dumpapp插件"><a href="#自定义dumpapp插件" class="headerlink" title="自定义dumpapp插件"></a>自定义dumpapp插件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Stetho.initialize(Stetho.newInitializerBuilder(context)</div><div class="line">        .enableDumpapp(<span class="keyword">new</span> DumperPluginsProvider() &#123;</div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> Iterable&lt;DumperPlugin&gt; <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Stetho.DefaultDumperPluginsBuilder(context)</div><div class="line">                .provide(<span class="keyword">new</span> HelloWorldDumperPlugin())</div><div class="line">                .provide(<span class="keyword">new</span> APODDumperPlugin(context.getContentResolver()))</div><div class="line">                .finish();</div><div class="line">          &#125;</div><div class="line">        &#125;)</div><div class="line">        .enableWebKitInspector(<span class="keyword">new</span> ExtInspectorModulesProvider(context))</div><div class="line">        .build());</div></pre></td></tr></table></figure>
<p>其中HelloWorldDumperPlugin和APODDumperPlugin是自定义的插件，具体内容可以参考<a href="https://github.com/facebook/stetho/tree/master/stetho-sample" target="_blank" rel="external">Stetho提供的sample程序</a><br>运行dumpapp脚本后以达到与app交互通信的效果。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ ./dumpapp <span class="_">-l</span></div><div class="line">apod</div><div class="line">crash</div><div class="line">files</div><div class="line">hello</div><div class="line">hprof</div><div class="line">prefs</div></pre></td></tr></table></figure></p>
<h4 id="原理简介"><a href="#原理简介" class="headerlink" title="原理简介"></a>原理简介</h4><p>其中dumpapp是一个python脚本，通信的方式使用的是android提供的<a href="https://android.googlesource.com/platform/system/core/+/master/adb/protocol.txt" target="_blank" rel="external">smartsocket接口</a><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">--- smartsockets -------------------------------------------------------</div><div class="line">Port <span class="number">5037</span> is used <span class="keyword">for</span> smart sockets which allow a client on the host</div><div class="line">side to request access to a service <span class="keyword">in</span> the host adb daemon or <span class="keyword">in</span> the</div><div class="line">remote (device) daemon.  The service is requested by ascii name,</div><div class="line">preceeded by a <span class="number">4</span> digit hex length.  Upon successful connection an</div><div class="line"><span class="string">"OKAY"</span> response is sent, otherwise a <span class="string">"FAIL"</span> message is returned.  Once</div><div class="line">connected the client is talking to that (remote or local) service.</div><div class="line">client: &lt;hex4&gt; &lt;service-name&gt;</div><div class="line">server: "OKAY"</div><div class="line">client: &lt;hex4&gt; &lt;service-name&gt;</div><div class="line">server: "FAIL" &lt;hex4&gt; &lt;reason&gt;</div></pre></td></tr></table></figure></p>
<p>使用PyCharm<a href="http://stackoverflow.com/questions/27952331/debugging-with-pycharm-terminal-arguments" target="_blank" rel="external">对Python进行断点调试</a>：<br><img src="http://ww3.sinaimg.cn/large/8b331ee1gw1fbfian208yj21kw0arwia.jpg" alt=""><br>这段脚本的功能就是通过读取<code>/proc/net/unix</code>文件去找app设置的socket<br><img src="http://ww2.sinaimg.cn/large/8b331ee1gw1fbfid70oipj21gs044t9m.jpg" alt=""></p>
<ol>
<li>扫描android所有提供socket功能的设备，找到steho的devtools_remote</li>
<li>建立与第一步找到的进程socket，然后通过smartsocket进行通信。</li>
<li>设备上的app相当于一个服务器，脚本是客户端对它进行访问</li>
</ol>
<p>后缀为_devtools_remote的socket是android留给chrome的后门。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Note that _devtools_remote is a magic suffix understood by Chrome which //causes the discovery process to begin.</span></div></pre></td></tr></table></figure></p>
<p>详细内容可以看这篇<a href="https://developer.chrome.com/devtools/docs/remote-debugging-legacy" target="_blank" rel="external">官方文档</a><br>这篇文档提供的例子是在命令行中输入下面的命令，就能在电脑上看到手机chrome中的内容了：<br><code>adb forward tcp:9222 localabstract:chrome_devtools_remote</code></p>
<p><img src="http://ww2.sinaimg.cn/large/8b331ee1gw1fbfijp8jqfj21320lo0tp.jpg" alt=""></p>
<p>打开的chrome-devtool其实是一个websocket连接。<br><img src="http://ww4.sinaimg.cn/large/8b331ee1gw1fbfipebrd2j21kw069766.jpg" alt=""><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePageList</span><span class="params">(LightHttpResponse response)</span></span></div><div class="line">    <span class="keyword">throws</span> JSONException &#123;</div><div class="line">  <span class="keyword">if</span> (mPageListResponse == <span class="keyword">null</span>) &#123;</div><div class="line">    JSONArray reply = <span class="keyword">new</span> JSONArray();</div><div class="line">    JSONObject page = <span class="keyword">new</span> JSONObject();</div><div class="line">    page.put(<span class="string">"type"</span>, <span class="string">"app"</span>);</div><div class="line">    page.put(<span class="string">"title"</span>, makeTitle());</div><div class="line">    page.put(<span class="string">"id"</span>, PAGE_ID);</div><div class="line">    page.put(<span class="string">"description"</span>, <span class="string">""</span>);</div><div class="line"></div><div class="line">    page.put(<span class="string">"webSocketDebuggerUrl"</span>, <span class="string">"ws://"</span> + mInspectorPath);</div><div class="line">    Uri chromeFrontendUrl = <span class="keyword">new</span> Uri.Builder()</div><div class="line">        .scheme(<span class="string">"http"</span>)</div><div class="line">        .authority(<span class="string">"chrome-devtools-frontend.appspot.com"</span>)</div><div class="line">        .appendEncodedPath(<span class="string">"serve_rev"</span>)</div><div class="line">        .appendEncodedPath(WEBKIT_REV)</div><div class="line">        .appendEncodedPath(<span class="string">"devtools.html"</span>)</div><div class="line">        .appendQueryParameter(<span class="string">"ws"</span>, mInspectorPath)</div><div class="line">        .build();</div><div class="line">    page.put(<span class="string">"devtoolsFrontendUrl"</span>, chromeFrontendUrl.toString());</div><div class="line"></div><div class="line">    reply.put(page);</div><div class="line">    mPageListResponse = LightHttpBody.create(reply.toString(), <span class="string">"application/json"</span>);</div><div class="line">  &#125;</div><div class="line">  setSuccessfulResponse(response, mPageListResponse);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在android上的服务端socket写法,<br>详见LocalSocketServer类的listenOnAddress方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">listenOnAddress</span><span class="params">(String address)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  mServerSocket = bindToSocket(address);</div><div class="line">  LogUtil.i(<span class="string">"Listening on @"</span> + address);</div><div class="line"></div><div class="line">  <span class="keyword">while</span> (!Thread.interrupted()) &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">// Use previously accepted socket the first time around, otherwise wait to accept another.</span></div><div class="line">      LocalSocket socket = mServerSocket.accept();</div><div class="line"></div><div class="line">      <span class="comment">// Start worker thread</span></div><div class="line">      Thread t = <span class="keyword">new</span> WorkerThread(socket, mSocketHandler);</div><div class="line">      t.setName(</div><div class="line">          WORKER_THREAD_NAME_PREFIX +</div><div class="line">          <span class="string">"-"</span> + mFriendlyName +</div><div class="line">          <span class="string">"-"</span> + mThreadId.incrementAndGet());</div><div class="line">      t.setDaemon(<span class="keyword">true</span>);</div><div class="line">      t.start();</div><div class="line">    &#125; <span class="keyword">catch</span> (SocketException se) &#123;</div><div class="line">      <span class="comment">// ignore exception if interrupting the thread</span></div><div class="line">      <span class="keyword">if</span> (Thread.interrupted()) &#123;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      &#125;</div><div class="line">      LogUtil.w(se, <span class="string">"I/O error"</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedIOException ex) &#123;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      LogUtil.w(e, <span class="string">"I/O error initialising connection thread"</span>);</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  LogUtil.i(<span class="string">"Server shutdown on @"</span> + address);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="对于JavaScript的支持"><a href="#对于JavaScript的支持" class="headerlink" title="对于JavaScript的支持"></a>对于JavaScript的支持</h3><p>Chrome开发者工具原生支持JavaScript，所以Stetho也提供了JavaScript的支持。<br>通过在console中输入如下代码可以让设备app弹出一个toast<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">importPackage(android.widget);</div><div class="line">importPackage(android.os);</div><div class="line"><span class="keyword">var</span> handler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</div><div class="line">handler.post(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; Toast.makeText(context, <span class="string">"Hello from JavaScript"</span>, Toast.LENGTH_LONG).show() &#125;);</div></pre></td></tr></table></figure></p>
<p><img src="http://ww3.sinaimg.cn/large/8b331ee1gw1fbfixpdt6hj21kw0rmgv8.jpg" alt=""><br>更多玩法见<a href="https://github.com/facebook/stetho/tree/master/stetho-js-rhino" target="_blank" rel="external">Rhino on Stetho
</a></p>
<hr>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><p><a href="http://facebook.github.io/stetho/" target="_blank" rel="external">http://facebook.github.io/stetho/</a><br><a href="https://github.com/facebook/stetho/tree/master/stetho-js-rhino" target="_blank" rel="external">https://github.com/facebook/stetho/tree/master/stetho-js-rhino</a><br><a href="https://www.figotan.org/2016/04/18/using-stetho-to-diagnose-data-on-android/" target="_blank" rel="external">https://www.figotan.org/2016/04/18/using-stetho-to-diagnose-data-on-android/</a><br><a href="https://developer.chrome.com/devtools/docs/remote-debugging-legacy" target="_blank" rel="external">https://developer.chrome.com/devtools/docs/remote-debugging-legacy</a><br><a href="https://android.googlesource.com/platform/system/core/+/master/adb/protocol.txt" target="_blank" rel="external">https://android.googlesource.com/platform/system/core/+/master/adb/protocol.txt</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://The-Coderz.github.io/2017/01/08/Stetho工具介绍/" data-id="cj1kekdoq000jb7ahnnp2vg9d" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/工具/">工具</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2017-01-05-powermock" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/05/2017-01-05-powermock/" class="article-date">
  <time datetime="2017-01-04T17:33:50.000Z" itemprop="datePublished">2017-01-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/05/2017-01-05-powermock/">【2017-01-05-powermock】</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="PowerMock"><a href="#PowerMock" class="headerlink" title="PowerMock"></a>PowerMock</h2><h3 id="PowerMock-github-project"><a href="#PowerMock-github-project" class="headerlink" title="PowerMock github project"></a><a href="https://github.com/powermock/powermock" target="_blank" rel="external">PowerMock github project</a></h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PowerMock是一个强大的测试框架，它集成了Mockito、EasyMock等测试框架，在基于这些框架的基础上，利用修改字节码的手段mock静态方法、私有方法、初始化方法，是一种对过去熟悉的测试框架的增强扩张。</p>
<hr>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol>
<li>引入PowerMock的jar包，需要注意不同版本的jar包依赖的JUnit版本；</li>
<li>建立测试类；</li>
<li>利用PowerMock写单测；</li>
</ol>
<hr>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="被测试接口：UserService"><a href="#被测试接口：UserService" class="headerlink" title="被测试接口：UserService"></a>被测试接口：UserService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.van.service;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 被测试类</div><div class="line"> * Created by Wuha on 2017/1/8.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">thePublicMethod</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="被测试类实现：UserServiceImpl"><a href="#被测试类实现：UserServiceImpl" class="headerlink" title="被测试类实现：UserServiceImpl"></a>被测试类实现：UserServiceImpl</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.van.service.impl;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.van.UserDAO;</div><div class="line"><span class="keyword">import</span> com.van.service.UserService;</div><div class="line"><span class="keyword">import</span> com.van.util.UserUtil;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Wuha on 2017/1/8.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserDAO userDAO;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Long XXXX_XXX_LONG;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String XXXX_XXXX_STRING;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.XXXX_XXX_LONG = <span class="number">0L</span>;</div><div class="line">        <span class="keyword">this</span>.XXXX_XXXX_STRING = <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(Long XXXX_XXX_LONG, String XXXX_XXXX_STRING)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.XXXX_XXX_LONG = XXXX_XXX_LONG;</div><div class="line">        <span class="keyword">this</span>.XXXX_XXXX_STRING = XXXX_XXXX_STRING;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">thePublicMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// some logic</span></div><div class="line"></div><div class="line">        <span class="keyword">this</span>.thePrivateMethod();</div><div class="line"></div><div class="line">        userDAO.getUserById(XXXX_XXX_LONG);</div><div class="line"></div><div class="line">        UserUtil.theStaticMethod();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> XXXX_XXXX_STRING;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">thePrivateMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// some logic</span></div><div class="line">        File file = <span class="keyword">new</span> File(XXXX_XXXX_STRING);</div><div class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</div><div class="line">            <span class="comment">// do some thing</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"file.exist() method mock failed."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="被测试类调用的静态方法"><a href="#被测试类调用的静态方法" class="headerlink" title="被测试类调用的静态方法"></a>被测试类调用的静态方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.van.util;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Wuha on 2017/1/8.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserUtil</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">theStaticMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// some logic</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"static method mock failed."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.van;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.van.service.UserService;</div><div class="line"><span class="keyword">import</span> com.van.service.impl.UserServiceImpl;</div><div class="line"><span class="keyword">import</span> com.van.util.UserUtil;</div><div class="line"><span class="keyword">import</span> org.junit.Assert;</div><div class="line"><span class="keyword">import</span> org.junit.Before;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</div><div class="line"><span class="keyword">import</span> org.mockito.*;</div><div class="line"><span class="keyword">import</span> org.mockito.invocation.InvocationOnMock;</div><div class="line"><span class="keyword">import</span> org.mockito.stubbing.Answer;</div><div class="line"><span class="keyword">import</span> org.powermock.api.mockito.PowerMockito;</div><div class="line"><span class="keyword">import</span> org.powermock.core.classloader.annotations.PrepareOnlyThisForTest;</div><div class="line"><span class="keyword">import</span> org.powermock.modules.junit4.PowerMockRunner;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Wuha on 2017/1/8.</div><div class="line"> */</div><div class="line"><span class="meta">@RunWith</span>(PowerMockRunner.class)     <span class="comment">// 测试运行于PowerMock测试框架下,加载特定对象、清除MockRepository等</span></div><div class="line"><span class="meta">@PrepareOnlyThisForTest</span>(&#123;UserUtil.class, UserServiceImpl.class&#125;)    <span class="comment">// 该在注解标明了需要用PowerMock字节码增强的类,如:mock静态方法、final域、私有方法等</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceTest</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXPECTED_STRING = <span class="string">"Hello world."</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Long EXPECTED_LONG = -<span class="number">1L</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Mock</span>                           <span class="comment">// mock 一个UserDAO类</span></div><div class="line">    <span class="keyword">private</span> UserDAO userDAO;</div><div class="line"></div><div class="line">    <span class="meta">@Mock</span></div><div class="line">    <span class="keyword">private</span> File mockFile;</div><div class="line"></div><div class="line">    <span class="meta">@Spy</span>  <span class="comment">// spy 一个类,这个注解产生的类,如果不去mock方法,那么在运行它的时候,会调用实际的方法,这点和mockObject.thenCallRealMethod()效果一样</span></div><div class="line">    <span class="meta">@InjectMocks</span>    <span class="comment">// 由于UserService利用了@Autowired注解,而没有public的setter方法,该注解可以帮助吧userDAO给set到service中</span></div><div class="line">    <span class="keyword">private</span> UserService userService = <span class="keyword">new</span> UserServiceImpl(EXPECTED_LONG, EXPECTED_STRING);</div><div class="line"></div><div class="line">    <span class="meta">@Before</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 对注解的对象进行语义逻辑处理</div><div class="line">         */</div><div class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * mock处理静态类</div><div class="line">         */</div><div class="line">        PowerMockito.mockStatic(UserUtil.class);</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * mock some method</div><div class="line">         */</div><div class="line">        PowerMockito.when(mockFile.exists()).thenReturn(<span class="keyword">true</span>);</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * mock一个construct方法</div><div class="line">         */</div><div class="line">        PowerMockito.whenNew(File.class).withArguments(Mockito.anyString()).thenReturn(mockFile);</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * mock static method, the private method mock is the same</div><div class="line">         */</div><div class="line">        PowerMockito.doNothing().when(UserUtil.class, <span class="string">"theStaticMethod"</span>);</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 对于DO对象,基本上在insert数据库后会填写该DO主键,有时候业务逻辑需要这个主键,</div><div class="line">         * 这时候,可以使用doAnswer来获取mock方法的入参,来设置id</div><div class="line">         *</div><div class="line">         * 注意,这里不能写成</div><div class="line">         * doAnswer(new Answer()&#123;...&#125;).when(mockObject.mockMethod);</div><div class="line">         * 需要改为:</div><div class="line">         *  ||          ||          ||          ||          ||</div><div class="line">         *  VV          VV          VV          VV          VV</div><div class="line">         *  doAnswer(new Answer()&#123;...&#125;).when(mockObject).mockMethod();</div><div class="line">         *  when中的方法必须拿出来,否则会报:mock的方法没有return值</div><div class="line">         */</div><div class="line">        Mockito.doAnswer(<span class="keyword">new</span> Answer() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">answer</span><span class="params">(InvocationOnMock invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                <span class="keyword">for</span> (Object arg : invocation.getArguments()) &#123;</div><div class="line">                    <span class="keyword">if</span> (arg <span class="keyword">instanceof</span> String) &#123;</div><div class="line">                        arg += <span class="string">"something"</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="string">"origin method expect return value : like thenReturn()"</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;).when(userDAO).saveUser(Mockito.anyString(), Mockito.anyInt());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testThePublicMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">        Assert.assertEquals(EXPECTED_STRING, userService.thePublicMethod());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><center><br><img src="/images/2017/01/08/powermock运行结果.png" alt="PowerMock运行结果"><br></center>

<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;按照代码中的逻辑，如果没被mock，则会抛出异常。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://The-Coderz.github.io/2017/01/05/2017-01-05-powermock/" data-id="cj1kekdof0008b7ahlpq3xuea" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-12-27-通过trace文件定位耗时操作" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/05/2016-12-27-通过trace文件定位耗时操作/" class="article-date">
  <time datetime="2017-01-04T17:09:24.000Z" itemprop="datePublished">2017-01-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/05/2016-12-27-通过trace文件定位耗时操作/">使用TraceView工具定位耗时操作</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://developer.android.com/studio/profile/traceview.html" target="_blank" rel="external">TraceView</a>是DDMS中的工具，可以用来定位Android app中java方法的耗时操作。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="1-生成trace文件"><a href="#1-生成trace文件" class="headerlink" title="1.生成trace文件"></a>1.生成trace文件</h3><p>Eclipse中生成trace文件的方法：<br><img src="http://ww4.sinaimg.cn/mw690/8b331ee1gw1fb5lfcb484j20zg0pmtf7.jpg" alt=""></p>
<p><br><br>Android Studio生成trace文件的方法:</p>
<p><img src="http://ww2.sinaimg.cn/large/8b331ee1gw1fb5lgu5dsmj21kw0fmgpk.jpg" alt=""></p>
<p>生成的trace文件将显示在Captures窗口</p>
<p><img src="http://ww2.sinaimg.cn/large/8b331ee1gw1fb5lx8hffej20a707jmxe.jpg" alt=""><br>直接把trace文件拖到安装了ADT插件的Eclipse就能打开。</p>
<h3 id="2-Timeline-Panel"><a href="#2-Timeline-Panel" class="headerlink" title="2.Timeline Panel"></a>2.Timeline Panel</h3><p>Timeline展示各个线程占用CPU的情况。<br>横轴为从开始到结束trace的CPU时间，右边纵轴表示各个线程，每一横排表示线程占用CPU的情况。这里主要看主线程main</p>
<p><img src="http://ww1.sinaimg.cn/large/8b331ee1gw1fb5lrgshrqj21kw07jtbu.jpg" alt=""></p>
<p>放大后的效果如图，每个method用不同的颜色表示，展示CPU调用该方法到结束调用的时间。</p>
<p><img src="http://ww1.sinaimg.cn/large/8b331ee1gw1fb5m32u3j6j21am0bcn0k.jpg" alt=""></p>
<h3 id="3-Profile-Panel"><a href="#3-Profile-Panel" class="headerlink" title="3.Profile Panel"></a>3.Profile Panel</h3><p>Profile Panel展示了方法全名，方法耗时，调用次数，及方法的调用链关系。<br>在这里调用方法称为”parent”,被调方法称为”children”.</p>
<p><img src="http://ww3.sinaimg.cn/large/8b331ee1gw1fb5mewco9uj21kw0ngtsb.jpg" alt=""></p>
<hr>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>《High Performance Android Apps》</p>
<p><a href="https://developer.android.com/studio/profile/traceview.html" target="_blank" rel="external">https://developer.android.com/studio/profile/traceview.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://The-Coderz.github.io/2017/01/05/2016-12-27-通过trace文件定位耗时操作/" data-id="cj1kekdoh000ab7ah5ieojk6l" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/图形学/">图形学</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-开源代码/">c++ 开源代码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具-docker/">工具 docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具-python/">工具 python</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/c-开源代码/" style="font-size: 15px;">c++ 开源代码</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/工具-docker/" style="font-size: 10px;">工具 docker</a> <a href="/tags/工具-python/" style="font-size: 10px;">工具 python</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/04/16/基于TCL语法的expect交互式脚本使用/">(no title)</a>
          </li>
        
          <li>
            <a href="/2017/04/16/Docker简单使用/">Docker简单使用</a>
          </li>
        
          <li>
            <a href="/2017/04/16/在macOS 10.12 上编译 Android 5.1/">在macOS 10.12 上编译 Android 5.1</a>
          </li>
        
          <li>
            <a href="/2017/04/16/xlog接入方案/">xlog接入方案</a>
          </li>
        
          <li>
            <a href="/2017/04/16/spdlog源码学习/">spdlog源码学习</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 The-Coders<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>